// knockout-postbox 0.6.0 | (c) 2017 Ryan Niemeyer |  http://www.opensource.org/licenses/mit-license
!function(a){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?a(require("knockout"),exports):"function"==typeof define&&define.amd?define(["knockout","exports"],a):a(ko,ko.postbox={})}(function(a,b,c){var d,e,f,g={},h=1;b.subscriptions=g,a.subscribable.call(b),b.topicCache={},b.serializer=a.toJSON,b.publish=function(a,c){a&&(b.topicCache[a]={value:c,serialized:b.serializer(c)},b.notifySubscribers(c,a))},f=b.subscribe,b.subscribe=function(a,d,e,i){var j,k,l;return a?("boolean"==typeof e&&(i=e,e=c),j=f.call(b,d,e,a),j.subId=++h,g[h]=j,i&&(k=b.topicCache[a],k!==c&&d.call(e,k.value)),l=j.dispose,j.dispose=function(){delete g[j.subId],l.call(j)},j):void 0},b.reset=function(){var a;for(var c in g)g.hasOwnProperty(c)&&(a=g[c],a&&"function"==typeof a.dispose&&a.dispose());b.topicCache={}},b.defaultComparer=function(a,c){return c&&b.serializer(a)===c.serialized},e=function(){var a,b=this;b.willDisposePostbox||(b.willDisposePostbox=!0,a=b.dispose,b.dispose=function(){var c,d,e,f,g=b.postboxSubs;if(g)for(c in g)if(g.hasOwnProperty(c)&&(d=g[c]))for(e in d)d.hasOwnProperty(e)&&(f=d[e],f&&"function"==typeof f.dispose&&f.dispose());a&&a.call(b)})},a.subscribable.fn.publishOn=function(a,c,f){var i,j,k;return e.call(this),a&&("function"==typeof c?f=c:i=c,f=f||b.defaultComparer,d.call(this,a,"publishOn"),j=this.subscribe(function(c){f.call(this,c,b.topicCache[a])||b.publish(a,c)},this),j.id=++h,g[h]=j,k=j.dispose,j.dispose=function(){delete this.postboxSubs[a].publishOn,delete g[j.id],k.call(j)}.bind(this),this.postboxSubs[a].publishOn=j,i||b.publish(a,this())),this},d=function(a,b){var c=this.postboxSubs=this.postboxSubs||{};c[a]=c[a]||{},c[a][b]&&c[a][b].dispose()},a.subscribable.fn.stopPublishingOn=function(a){return d.call(this,a,"publishOn"),this},a.subscribable.fn.subscribeTo=function(f,g,h){var i,j,k,l,m,n=this;return e.call(this),"function"==typeof g?h=g:i=g,f&&a.isWriteableObservable(this)&&(d.call(this,f,"subscribeTo"),k=function(a){n(h?h.call(n,a):a)},l=b.subscribe(f,k),this.postboxSubs[f].subscribeTo=l,m=l.dispose,l.dispose=function(){delete this.postboxSubs[f].subscribeTo,m.call(l)}.bind(this),i&&(j=b.topicCache[f],j!==c&&k(j.value))),this},a.subscribable.fn.unsubscribeFrom=function(a){return d.call(this,a,"subscribeTo"),this},a.subscribable.fn.syncWith=function(a,b,c,d){return this.subscribeTo(a,b).publishOn(a,c,d),this},a.subscribable.fn.stopSyncingWith=function(a){return this.unsubscribeFrom(a).stopPublishingOn(a),this},a.postbox=b});